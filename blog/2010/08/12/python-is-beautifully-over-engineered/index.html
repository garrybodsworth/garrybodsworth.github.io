
<!DOCTYPE HTML>
<html lang="en-gb">
<head>
  <meta charset="UTF-8">
  <title>Fragmented Memory</title>

  <meta name="author" content="Garry Bodsworth">
  
  <meta name="description" content="Python Is Beautifully Over-engineered Aug 12th, 2010 I could have called this &#8220;Don&#8217;t re-invent the wheel&#8221;. Sometimes the Python &hellip;">
  
  

  <link rel="canonical" href="http://www.fragmentedmemory.com/blog/2010/08/12/python-is-beautifully-over-engineered">
  <link href="/favicon.png" rel="icon">
  <link href="/stylesheets/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="/feed/" rel="alternate" title="Fragmented Memory" type="application/atom+xml">
</head>
  
<body class="default">
  <div id="wrapper">
    <div id="header">
  <h1><a href="/">Fragmented Memory</a></h1>
  
    <p>Garry Bodsworth's Blog (formerly Garry's Bit Patterns &amp; Programmer's Log)</p>
  
</div>
<ul id="social-links">
  
    <li><a class="rss" href="/feed/" title="RSS">RSS</a></li>
  
  
  
  
    <li><a class="twitter" href="http://twitter.com/garrybodsworth" title="Twitter">Twitter</a></li>
  
  
    <li><a class="github" href="https://github.com/garrybodsworth" title="GitHub">GitHub</a></li>
  
  
  
  
  
  
    <li><a class="pinboard" href="https://pinboard.in/u:garrybodsworth" title="Pinboard">Pinboard</a></li>
  
</ul>
<div class="clear"></div>
<ul id="nav">
  
    <li> <a href="/">blog</a> </li>
  

  
    <li><a href="/blog/archives">archives</a></li>
  

  
    <li><a href="/about">about</a></li>
  
</ul>

    <div id="main"> <div class="post-header">
  
    <h1 class="post-title">Python Is Beautifully Over-engineered</h1>
  
  








  


<time datetime="2010-08-12T00:00:00+01:00" pubdate data-updated="true">Aug 12<span>th</span>, 2010</time>
</div>

<div class="post-content"><p>I could have called this &#8220;Don&#8217;t re-invent the wheel&#8221;. Sometimes the Python standard library really surprises me because some bits are very over-engineered, but in a really good way. First time I realised this was when I was working on what became <a href="http://github.com/garrybodsworth/coda_network">coda_network</a> as most people solving the proxy problem and other downloading issues just write a new network library, but there are some really handy base classes to derive from to solve it. Admittedly it did require some bug fixing along the way, but it was kind of worthwhile.</p>

<p>In coda_network I&#8217;ve got a mini proxy using ForkingMixin to do a process per download bypassing a lot of GIL based multithreading pain. I needed some more multi processing support for some shared state and possibly locking. So I started trying to do a MultiprocessingMixIn for the SocketServer/TCPServer/BaseHTTPServer. I thought &#8220;this is easy just rip off the threading one since they share the same interface&#8221;. That worked really well for general use but when I started putting the system under severe load the process cleanup started going wonky.</p>

<p>Eventually I think I got it working using this code:</p>

<pre lang="PYTHON" line="1" file="MultiProcessingMixin.py" colla="+">class MultiprocessingMixIn:
    """Mix-in class to handle each request in a new process."""

    # Decides how process will act upon termination of the
    # main process
    daemon_processes = False

    def process_request_process(self, request, client_address):
        """
        Same as in BaseServer but as a thread.
        In addition, exception handling is done here.
        """
        try:
            # Actually do the request
            self.finish_request(request, client_address)
        except:
            # XXX: will this work with multiprocessing correctly?
            self.handle_error(request, client_address)
        finally:
            # Close the socket request
            self.close_request(request)

    def process_request(self, request, client_address):
        """Start a new thread to process the request."""
        t = multiprocessing.Process(target = self.process_request_process,
                             args=(request, client_address))
        if self.daemon_processes:
            t.daemon = True
        t.start()
        # Now we close the parent request socket because the child process
        # is now responsible for it
        self.close_request(request)
</pre>


<p>The important bit is closing the request in the parent after the child process has started since it takes responsibility for it then.</p>

<pre lang="PYTHON" line="1" colla="+">class ProxyServer(MultiprocessingMixIn, BaseHTTPServer.HTTPServer):
    pass

proxy = ProxyServer(address, HttpResponder)
proxy.serve_forever()
</pre>


<p>I&#8217;ve probably missed a couple of bits (like making sure the handle_error does what is expected) but this is at least a good starting point&#8230;.</p>
</div>


<div class="post-single">
  <div class="post-meta">
    

<span class="categories">
  Categories:
  
    <a class='category' href='/blog/categories/uncategorized/'>Uncategorized</a>
  
</span>


    
      <div class="sharing">
  
  <a href="http://twitter.com/share" class="twitter-share-button" data-url="http://www.fragmentedmemory.com/blog/2010/08/12/python-is-beautifully-over-engineered/" data-via="garrybodsworth" data-counturl="http://www.fragmentedmemory.com/blog/2010/08/12/python-is-beautifully-over-engineered/" >Tweet</a>
  
  
  
</div>

    
  </div>
  <div class="clear"></div>

  
</div>
 </div>
    <div id="footer">
  <div class="panels">
    <div class="license">
      <h2>License</h2>
      <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/"><img alt="Creative Commons License" style="border-width:0" src="http://i.creativecommons.org/l/by-nc-sa/3.0/88x31.png" /></a><br />This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/">Creative Commons Attribution-NonCommercial-ShareAlike 3.0 Unported License</a>.
    </div>

    <div class="posts">
      <h2>Recent Posts</h2>
      <ul>
        
          <li>
            <a href="/blog/2013/06/22/rss-feed-moved-to-http-slash-slash-www-dot-fragmentedmemory-dot-com-slash-feed-slash/">RSS Feed Moved To http://www.fragmentedmemory.com/feed/</a>
          </li>
        
          <li>
            <a href="/blog/2013/06/18/new-location-and-new-blog-engine-and-old-content-restored/">New Location &amp; New Blog Engine &amp; Old Content Restored</a>
          </li>
        
          <li>
            <a href="/blog/2013/06/13/joining-microsoft/">Joining Microsoft</a>
          </li>
        
          <li>
            <a href="/blog/2013/06/13/leaving-bromium/">Leaving Bromium</a>
          </li>
        
          <li>
            <a href="/blog/2013/03/05/philip-su-engineering-process-and/">Philip Su - Engineering Process And Philosophy At Facebook</a>
          </li>
        
      </ul>
    </div>
  </div>

  <p class="powered">
    Powered by <a href="http://octopress.org">Octopress</a> and <a href="https://github.com/iwinux/compbits">Compbits</a>
  </p>
</div>

  </div> <!-- #wrapper end -->

  

  


  

  

  
  <script type="text/javascript">
    (function(){
      var twitterWidgets = document.createElement('script');
      twitterWidgets.type = 'text/javascript';
      twitterWidgets.async = true;
      twitterWidgets.src = 'http://platform.twitter.com/widgets.js';
      document.getElementsByTagName('head')[0].appendChild(twitterWidgets);
    })();
  </script>


</body>
</html>
